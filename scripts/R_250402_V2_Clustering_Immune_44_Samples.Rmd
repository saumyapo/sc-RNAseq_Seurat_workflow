---
title: "Immune 44 Samples HIV vs Control Clustering V2 (Filtered Doublets)"
author: "Saumya"
date: "`r Sys.Date()`"
output:
  html_document:
    df_print: paged
---

```{r, results=FALSE, echo=FALSE, message=FALSE, warning=FALSE}
# Markdown parameters
set_echo = FALSE
set_eval = FALSE
```

```{r, results=FALSE, echo=FALSE, message=FALSE, warning=FALSE}
# Function to set markdown text color
colorize <- function(x, color) {
  if (knitr::is_latex_output()) {
    sprintf("\\textcolor{%s}{%s}", color, x)
  } else if (knitr::is_html_output()) {
    sprintf("<span style='color: %s;'>%s</span>", color,
      x)
  } else x
}
```


```{r, include=FALSE}
# Set height of chunk output
options(width = 60)
local({
  hook_output <- knitr::knit_hooks$get('output')
  knitr::knit_hooks$set(output = function(x, options) {
    if (!is.null(options$max.height)) options$attr.output <- c(
      options$attr.output,
      sprintf('style="max-height: %s;"', options$max.height)
    )
    hook_output(x, options)
  })
})
```

```{r, results = FALSE, echo=set_echo, message=FALSE, warning=FALSE}
# Load packages
library(dplyr)
library(Seurat)
library(patchwork)
library(ggplot2)
library(cowplot)
library(rmarkdown)
library(SummarizedExperiment)
library(htmlwidgets)
library(htmltools)
library(shiny)
library(openxlsx)
library(scDblFinder)
library(hdf5r)
library(harmony, lib.loc ="/hpc/users/pothus02/.Rlib")
library(DT)
```

<!-- Information of Used Library -->
### `r colorize('Information of Used R Libraries', 'blue')` 

The following R libraries were used to process the data and produce this report.

R: `r R.Version()$version.string`,

dplyr: `r packageVersion('dplyr')`, 

Seurat: `r packageVersion('Seurat')`, 

patchwork: `r packageVersion('patchwork')`, 

ggplot2: `r packageVersion('ggplot2')`, 

cowplot: `r packageVersion('cowplot')`,

scDblFinder: `r packageVersion('scDblFinder')`

```{r, results = FALSE, echo=set_echo, message=FALSE, warning=FALSE}
suffix <- "Seurat"
sampleNames <- c("DART002LC_BL", "DART003LC", "DART005LC", "DART006LC", "DART007LC", "HIV018_CA", "HIV022_CA", "HIV032_CA", "HIV058_LP", "HIV063_LP", "HIV075_LP", "HIV076_LP", "HIV077_LP", "HIV078_LP", "HIV080_LP", "HIV081_LP", "HIV082_LP", "HIV083_LC", "HIV084_LP", "HIV086_LC", "HIV087_LP", "HIV090_LC", "HIV091_LC", "HIV092_LC", "HIV093_LC", "HIV094_LC", "HIV098_LC", "NV144_LP", "NV157_LP_LC", "NV159_LP_LC", "NV161_LC", "NV162_LP_LC", "NV186_LP", "NV201_LP", "NV203_LP", "NV205_LP", "NV212_LC", "NV213_LC", "NV216_LP", "NV222_LP", "NV225_LP", "NV230_LP", "NV234_LC", "NV244_LC", "NV245_LC")

SAMPLE_GROUP <- c("HIV", "HIV", "HIV","HIV","HIV","HIV","HIV","HIV","HIV","HIV","HIV","HIV","HIV","HIV","HIV","HIV","HIV","HIV","HIV","HIV","HIV","HIV","HIV","HIV","HIV","HIV","HIV","Control","Control","Control","Control","Control","Control","Control","Control","Control","Control","Control", "Control", "Control", "Control","Control","Control","Control","Control")
data_dir <- ("../raw_h5/")
projectName <- "Immune HIV vs Control"
h5_string <- "_filtered_feature_bc_matrix.h5"

#Seurat parameters
variables.features <- 2000
nPCs <- 50
```

# `r colorize('Unfiltered 44 Immune samples ', 'blue')`

```{r,results='asis', echo=FALSE, message=FALSE, warning=FALSE}
data.combined <- readRDS("/sc/arion/projects/mehandrulab/saumya/pablo_HIV/immune/V2/RDS/data_44_umap_33_clusters.RDS")
Idents(data.combined) <- "seurat_clusters"
DimPlot(data.combined, reduction = "umap", label = TRUE, raster = FALSE) + ggtitle ("Before Filtering")
```


```{r, eval= FALSE, results = FALSE, echo=set_echo, message=FALSE, warning=FALSE}
# data_filtered <- subset(data.combined, idents = c("19","26","30","32"), invert = TRUE)
# saveRDS(data_filtered, "../RDS/data_filt_44_umap_29_clusters.RDS")
```

# `r colorize('Filtered 44 Immune samples ', 'blue')`

```{r,results='asis', echo=FALSE, message=FALSE, warning=FALSE}
data.combined <- readRDS("../RDS/data_filt_44_umap_29_clusters.RDS")
Idents(data.combined) <- "seurat_clusters"
# Check clustering UMAP
DimPlot(data.combined, reduction = "umap", label = TRUE, repel = TRUE, raster=FALSE) + ggtitle("After Filtering")

#ElbowPlot(data.combined, ndims = 50)
```


<!-- # `r colorize('Doublet Detection', 'blue')` -->

```{r, eval = FALSE, results = FALSE, echo=FALSE, message=FALSE, warning=FALSE}
#Doublet detection using scDblfinder)
#data.combined <- readRDS("../RDS/data_44_umap_33_clusters.RDS")
# DefaultAssay(data.combined) <- "RNA"
# set.seed(100)
# 
# sce <- data.combined
# sce %<>% JoinLayers() %>% as.SingleCellExperiment() #Since there are multiple layers and sce needs to be 1
# sce <- scDblFinder(sce)
# table(sce$scDblFinder.class)
# sce@colData@listData %>% as.data.frame() %>% head()
```

```{r, eval = FALSE, results = FALSE, echo=FALSE, message=FALSE, warning=FALSE}
# data.combined <- readRDS("../RDS/data_44_umap_33_clusters.RDS")
# meta_scdblfinder <- sce@colData@listData %>% as.data.frame() %>%
#   dplyr::select(starts_with('scDblFinder')) # 'scDblFinder.class')
# head(meta_scdblfinder)
# 
# # Explore results and add to seurat object
# meta_scdblfinder <- sce@colData@listData %>% as.data.frame() %>%
#   dplyr::select(starts_with('scDblFinder')) # 'scDblFinder.class')
# head(meta_scdblfinder)
# rownames(meta_scdblfinder) <- sce@colData@rownames
# head(meta_scdblfinder)
# data.combined <- AddMetaData(object = data.combined, metadata = meta_scdblfinder %>% dplyr::select('scDblFinder.class'))
```

```{r, eval = FALSE, results = FALSE, echo=FALSE, message=FALSE, warning=FALSE}
#Save RDS with doublet information
#saveRDS(data.combined, file = paste("../RDS/data_44_umap_33_clusters.RDS"))
```

```{r, echo=FALSE, message=FALSE, warning=FALSE}
# data.combined <- readRDS("../RDS/data_filt_44_umap_29_clusters.RDS")
# 
# # Get the total number of cells in the dataset
# total_cells <- length(Cells(data.combined))
# 
# # Get the count of cells retained after filtering
# singlet_count <- sum(data.combined$scDblFinder.class == "singlet")
# 
# # Calculate the number of mitochondrial cells 
# doublet_count <- sum(data.combined$scDblFinder.class == "doublet")
# 
# # Calculate percentages
# singlet_percentage <- (singlet_count / total_cells) * 100
# doublet_percentage <- (doublet_count / total_cells) * 100
# 
# # Create a summary table
# doublet_summary <- data.frame(
#   "Category" = c("Total Cells", "Singlet Cells", "Doublet Cells"),
#   "Raw Count" = c(total_cells, singlet_count, doublet_count),
#   "Percentage" = c(100, singlet_percentage, doublet_percentage)
# )
```

<!-- ## Doublet Count Summary {.tabset} -->


```{r, results='asis', echo=FALSE, message=FALSE, warning=FALSE}
# # Display the summary table
# cat("###", "Doublet Summary", " \n")
# paged_table(doublet_summary)
# cat(" \n \n")
# # Visualize with the annotated cell types
# cat("###", "Doublet Dimplot", " \n")
# DimPlot(data.combined, reduction = "umap", group.by="scDblFinder.class") + ggtitle("Doublet Distribution")
# cat(" \n \n")
```


# `r colorize('Clustering Step 2: Find Markers', 'blue')`

Find markers for every cluster compared to all remaining cells, report both positive and negative ones. You can check the top 20 markers(selected based on the largest values of avg_log2FC or pct.ratio) and also all markers for each cluster on the following data table. The results data frame has the following columns:

* cluster: cluster label.
* gene: gene name
* p_val: p value (unadjusted) can take any value between 0 and 1. Values close to 0 indicate that the observed gene expression difference between the cluster and the rest clusters is unlikely to be due to chance, whereas a p value close to 1 suggests no difference between the cluster and the rest clusters other than due to chance.
* avg_log2FC: log fold-change of the average expression between the cluster and the rest clusters. Positive values indicate that the gene is more highly expressed in the cluster.
* pct.1: The percentage of cells where the gene is detected in the cluster.
* pct.2: The percentage of cells where the gene is detected in the rest clusters.
* p_val_adj: Adjusted p value, based on Bonferroni correction using all genes in the dataset.
* pct.ratio: The ratio between pct.1 and pct.2.

Markers were found after refining (aka sub-clustering and identifying amibuguous cell populations)

```{r, eval = FALSE, echo=FALSE, message=FALSE, warning=FALSE}
# Find All Markers
# data.combined <- readRDS("../RDS/data_filt_44_umap_29_clusters.RDS")
# DefaultAssay(data.combined) <- "RNA"
# Idents(data.combined) <- "seurat_clusters"
# data.combined <- JoinLayers(data.combined)
# data.markers <- FindAllMarkers(data.combined, only.pos = FALSE, min.pct = 0.25, logfc.threshold = 0.25)
# # Save markers
# write.csv(data.markers, file='../csvs/data_filt_44_all_markers_29_clusters.csv')
```


```{r, eval = FALSE, echo=FALSE, message=FALSE, warning=FALSE}
# # Find All Markers
# data.combined <- readRDS("../RDS/data_44_umap_33_clusters.RDS")
# Idents(data.combined) <- "sample_names"
# data.markers <- FindAllMarkers(data.combined, only.pos = FALSE, min.pct = 0, logfc.threshold = 0)
# Apply FDR (Benjamini-Hochberg) correction manually
#data.markers$p_val_adj <- p.adjust(data.markers$p_val, method = "fdr")
# # Save markers
# write.csv(data.markers, file='../csvs/data_IBDU013_deg_all_markers_sample.csv')
```

```{r, echo=FALSE, message=FALSE, warning=FALSE}
# Read Markers .csv
data.markers = read.csv('../csvs/data_filt_44_all_markers_29_clusters.csv')
data.markers$pct.diff = data.markers$pct.1 - data.markers$pct.2
data.markers$pct.ratio = data.markers$pct.1 / data.markers$pct.2
avglog_p = data.markers %>% group_by(cluster) %>% slice_max(n = 20, order_by = avg_log2FC)
avglog_n = data.markers %>% group_by(cluster) %>% slice_min(n = 20, order_by = avg_log2FC)
pctdiff_p = data.markers %>% group_by(cluster) %>% slice_max(n = 20, order_by = pct.diff)
pctdiff_n = data.markers %>% group_by(cluster) %>% slice_min(n = 20, order_by = pct.diff)
pctratio_p = data.markers %>% group_by(cluster) %>% slice_max(n = 20, order_by = pct.ratio)
pctratio_n = data.markers %>% group_by(cluster) %>% slice_min(n = 20, order_by = pct.ratio)
```


```{r, eval = FALSE, echo=FALSE, message=FALSE, warning=FALSE}

positive.markers = read.csv('../csvs/data_filt_44_all_markers_29_clusters.csv')

positive.markers$pct.diff = positive.markers$pct.1 - positive.markers$pct.2
positive.markers$pct.ratio = positive.markers$pct.1 / positive.markers$pct.2

# Keep positive markers only
positive.markers <- positive.markers[positive.markers$pct.diff > 0.0,]

positive.markers = positive.markers %>% group_by(cluster) %>% slice_max(n = 200, order_by = pct.diff)


write.csv(positive.markers, file='../csvs/data_filt_44_pos_markers_29_clusters.csv')

```



```{r, eval = FALSE, echo=FALSE, message=FALSE, warning=FALSE}
#paged_table(positive.markers)
```



## Positive markers {.tabset}
While downloading tables please make sure to change filename, otherwise it might overwrite if downloading multiple tables. Make sure to include ".csv" after changing filename to retain format.

### Top 20 Markers (avg_log2FC)
```{r,results='asis', echo=FALSE, message=FALSE, warning=FALSE}
# Create a table with a CSV download option
datatable(
  avglog_p, 
  extensions = 'Buttons', 
  options = list(
    dom = 'Bfrtip',
    buttons = list('csv'),
    filter = "top"  # Ensures a search box appears
  )
)
```

### Top 20 Markers (pctdiff)
```{r,results='asis', echo=FALSE, message=FALSE, warning=FALSE}
datatable(
  pctdiff_p, 
  extensions = 'Buttons', 
  options = list(
    dom = 'Bfrtip',
    buttons = list('csv'),
    filter = "top"
  )
)
```

### Top 20 Markers (pct.ratio)
```{r,results='asis', echo=FALSE, message=FALSE, warning=FALSE}
datatable(
  pctratio_p, 
  extensions = 'Buttons', 
  options = list(
    dom = 'Bfrtip',
    buttons = list('csv', 'search')
  )
)
```


## Negative markers {.tabset}
While downloading tables please make sure to change filename, otherwise it might overwrite if downloading multiple tables. Make sure to include ".csv" after changing filename to retain format.

### Top 20 Markers (avg_log2FC)
```{r,results='asis', echo=FALSE, message=FALSE, warning=FALSE}
# Create a table with a CSV download option
datatable(
  avglog_n, 
  extensions = 'Buttons', 
  options = list(
    dom = 'Bfrtip',
    buttons = list('csv'),
    filter = "top"  # Ensures a search box appears
  )
)
```

### Top 20 Markers (pctdiff)
```{r,results='asis', echo=FALSE, message=FALSE, warning=FALSE}
datatable(
  pctdiff_n, 
  extensions = 'Buttons', 
  options = list(
    dom = 'Bfrtip',
    buttons = list('csv'),
    filter = "top"
  )
)
```

### Top 20 Markers (pct.ratio)
```{r,results='asis', echo=FALSE, message=FALSE, warning=FALSE}
datatable(
  pctratio_n, 
  extensions = 'Buttons', 
  options = list(
    dom = 'Bfrtip',
    buttons = list('csv', 'search')
  )
)
```

## All markers
While downloading tables please make sure to change filename, otherwise it might overwrite if downloading multiple tables. Make sure to include ".csv" after changing filename to retain format.

```{r,results='asis', echo=FALSE, message=FALSE, warning=FALSE}
# Create a table with a CSV download option
datatable(
  data.markers, 
  extensions = 'Buttons', 
  options = list(
    dom = 'Bfrtip',
    buttons = list('csv')
  )
)
```

```{r, echo=FALSE, message=FALSE, warning=FALSE}
# data.combined <- readRDS("../RDS/data_filt_44_umap_29_clusters.RDS")

# Idents(data.combined) <- "seurat_clusters"
# 
# data.combined$old_seurat_clusters <- data.combined$seurat_clusters
# 
# seurat_cluster_labels <- c("0" = "0",
#                          "1" = "1",
#                          "2" = "2",
#                          "3" = "3",
#                          "4" = "4",
#                          "5" = "5",
#                          "6" = "6",
#                          "7" = "7",
#                          "8" = "8",
#                          "9" = "9",
#                          "10" = "10",
#                          "11" = "11",
#                          "12" = "12",
#                          "13" = "13",
#                          "14" = "14",
#                          "15" = "15",
#                          "16" = "16",
#                          "17" = "17",
#                          "18" = "18",
#                          "20" = "19",
#                          "21" = "20",
#                          "22" = "21",
#                          "23" = "22",
#                          "24" = "23",
#                          "25" = "24",
#                          "27" = "25",
#                          "28" = "26",
#                          "29" = "27",
#                          "31" = "28")
# 
# #Apply the new annotations to your Seurat object
# data.combined$seurat_clusters <- plyr::mapvalues(
#   Idents(data.combined),
#    from = names(seurat_cluster_labels),
#   to = seurat_cluster_labels
# )
# 
# #Update the identities in the Seurat object
# Idents(data.combined) <- data.combined$seurat_clusters
# #
# saveRDS(data.combined, "../RDS/data_filt_44_umap_29_clusters.RDS")
```


```{r, echo=FALSE, message=FALSE, warning=FALSE}
# data.combined <- readRDS("../RDS/data_filt_44_umap_29_clusters.RDS")
# 
# Idents(data.combined) <- "seurat_clusters"
# 
# cluster_annotations <- c("0" = "PC",
#                          "1" = "PC",
#                          "2" = "CD4 T",
#                          "3" = "CD8 T",
#                          "4" = "Mast cell",
#                          "5" = "B cell",
#                          "6" = "CD8 T",
#                          "7" = "ABCA8 Stroma",
#                          "8" = "Endothelial cells",
#                          "9" = "Epithelial",
#                          "10" = "Treg",
#                          "11" = "IgG PC",
#                          "12" = "PDGFRA Stroma",
#                          "13" = "Glia",
#                          "14" = "Myeloid",
#                          "15" = "Myeloid",
#                          "16" = "PC",
#                          "17" = "PC",
#                          "18" = "Stroma",
#                          "19" = "CD4 T",
#                          "20" = "Endothelial cells",
#                          "21" = "Pericyte",
#                          "22" = "Proliferating",
#                          "23" = "PC",
#                          "24" = "ILC",
#                          "25" = "PC",
#                          "26" = "Goblet cells",
#                          "27" = "CD8 T",
#                          "28" = "Tuft")
# 
# #Apply the new annotations to your Seurat object
# data.combined$cluster_label <- plyr::mapvalues(
#   Idents(data.combined),
#    from = names(cluster_annotations),
#   to = cluster_annotations
# )
# 
# #Update the identities in the Seurat object
# Idents(data.combined) <- data.combined$cluster_label
# #
# saveRDS(data.combined, "../RDS/data_filt_44_umap_29_clusters.RDS")
```

# `r colorize('Annotated Clusters', 'blue')`

```{r,results='asis', echo=FALSE, message=FALSE, warning=FALSE, fig.width=12, fig.height=8}
data.combined <- readRDS("../RDS/data_filt_44_umap_29_clusters.RDS")
Idents(data.combined) <- "cluster_label"
# Check clustering UMAP
DimPlot(data.combined, reduction = "umap", label = TRUE, repel = TRUE, raster=FALSE) + ggtitle("Seurat Clusters")

#ElbowPlot(data.combined, ndims = 50)
```


# `r colorize('Cell Count Distribution in Clusters', 'blue')` {.tabset}

```{r, echo=FALSE, message=FALSE, warning=FALSE}
# Load filtered dataset
data.combined <- readRDS("../RDS/data_filt_44_umap_29_clusters.RDS")

# Count number of cells per sample
cell_counts <- table(data.combined$seurat_clusters)

# Convert to data frame
df_counts <- as.data.frame(cell_counts)
colnames(df_counts) <- c("Cluster", "Cell_Count")

# Calculate percentage distribution (ensuring it sums to 100)
df_counts$Percentage <- (df_counts$Cell_Count / sum(df_counts$Cell_Count)) * 100

# Bar plot for percentage distribution with y-axis fixed from 0 to 100
p1 <- ggplot(df_counts, aes(x = Cluster, y = Percentage, fill = Cluster)) +
  geom_bar(stat = "identity") +
  theme_minimal() +
  labs(
    title = "Cell Percentage Distribution Across Clusters",
    x = "Cluster",
    y = "Percentage of Total Cells",
    fill = "Cluster"
  ) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1), legend.position = "none")

# Bar plot for raw counts
p2 <- ggplot(df_counts, aes(x = Cluster, y = Cell_Count, fill = Cluster)) +
  geom_bar(stat = "identity") +
  theme_minimal() +
  labs(
    title = "Raw Cell Count Distribution Across Clusters",
    x = "Cluster",
    y = "Number of Cells",
    fill = "Cluster"
  ) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1), legend.position = "none")
```


```{r, results='asis', echo=FALSE, message=FALSE, warning=FALSE}
cat("##", "Raw Count Distribution", " \n")
print(p2)
cat ('\n \n')
cat("##", "Percentage Distribution", " \n")
print(p1)
cat ('\n \n')
```


```{r, echo=FALSE, message=FALSE, warning=FALSE}
# Extract raw counts for the neutrophil cluster (cluster 5)
# ILC_cells <- WhichCells(data.combined, ident = "24")
# 
# # Get the raw count of neutrophil cells
# ILC_count <- length(ILC_cells)
# 
# # Get the total number of cells in the dataset
# total_cells <- length(Cells(data.combined))
# 
# # Calculate the percentage of neutrophils in the dataset
# ILC_percentage <- (ILC_count / total_cells) * 100
# 
# # Create a summary table
# summary_table <- data.frame(
#   "Cell Type" = c("ILCs", "Total Cells"),
#   "Raw Count" = c(ILC_count, total_cells),
#   "Percentage" = c(ILC_percentage, 100)
# )
```

<!-- # Cell Count for Cluster 24 (ILC) {.tabset} -->
```{r, results='asis', echo=FALSE, message=FALSE, warning=FALSE}
# Display the summary table
#paged_table(summary_table)
```

